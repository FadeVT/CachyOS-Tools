#!/bin/bash
# cachy-maintain maintenance — system maintenance operation functions
# shellcheck disable=SC2015

# ─── Orphan package removal ──────────────────────────────────────────
do_orphans() {
    echo -e "\n\033[1;33m-->\033[1;34m Orphaned Packages\033[0m\n"

    local orphans
    orphans="$(pacman -Qdtq 2>/dev/null)" || true

    if [[ -z "$orphans" ]]; then
        echo -e "\033[1;32mNo orphaned packages found.\033[0m"
        return 0
    fi

    echo -e "The following packages are no longer required by any installed package:\n"
    echo "$orphans" | while read -r pkg; do
        echo -e "  \033[2m•\033[0m $pkg"
    done
    echo

    echo -ne "\033[1;32mRemove these orphaned packages? [y/N] \033[0m"
    read -r response
    if [[ "$response" =~ ^[Yy]$ ]]; then
        echo
        # shellcheck disable=SC2086
        pacman -Rns --noconfirm $orphans || {
            echo -e "\033[1;31mFailed to remove some orphaned packages.\033[0m"
            return 1
        }
        echo -e "\n\033[1;32mOrphaned packages removed.\033[0m"
    else
        echo -e "\033[2mSkipped.\033[0m"
    fi
}

# ─── Package cache cleanup ───────────────────────────────────────────
do_cache() {
    local keep=3
    if [[ "$1" == "--all" ]]; then
        keep=1
    fi

    echo -e "\n\033[1;33m-->\033[1;34m Package Cache Cleanup\033[0m\n"

    if ! command -v paccache >/dev/null; then
        echo -e "\033[1;31mpaccache not found. Install pacman-contrib:\033[0m"
        echo -e "\033[2m   sudo pacman -S pacman-contrib\033[0m"
        return 1
    fi

    echo -e "Cleaning package cache (keeping \033[1;36m$keep\033[0m version(s) of each package)...\n"
    paccache -r -k "$keep"
    echo

    # Also clean uninstalled package cache
    echo -e "Removing cached packages for uninstalled software...\n"
    paccache -ruk0
}

# ─── Remove stale pacman database lock ───────────────────────────────
do_unlock() {
    local lockfile="/var/lib/pacman/db.lck"

    echo -e "\n\033[1;33m-->\033[1;34m Pacman Database Lock\033[0m\n"

    if [[ ! -f "$lockfile" ]]; then
        echo -e "\033[1;32mNo lock file found. Pacman database is not locked.\033[0m"
        return 0
    fi

    # Check if pacman is actually running
    if pgrep -x pacman >/dev/null; then
        echo -e "\033[1;31mWarning: pacman is currently running!\033[0m"
        echo -e "\033[1;31mRemoving the lock while pacman is active can corrupt the database.\033[0m"
        echo -ne "\033[1;31mRemove anyway? [y/N] \033[0m"
    else
        echo -e "Lock file exists but pacman is not running."
        echo -e "This is likely a stale lock from a crashed or interrupted operation."
        echo -ne "\033[1;32mRemove lock file? [y/N] \033[0m"
    fi

    read -r response
    if [[ "$response" =~ ^[Yy]$ ]]; then
        rm -f "$lockfile"
        echo -e "\n\033[1;32mLock file removed.\033[0m"
    else
        echo -e "\033[2mSkipped.\033[0m"
    fi
}

# ─── Log and cache cleanup ───────────────────────────────────────────
do_logs() {
    echo -e "\n\033[1;33m-->\033[1;34m System Log & Cache Cleanup\033[0m\n"

    # Journal cleanup
    echo -e "\033[1;36m── Journal Logs ──\033[0m"
    echo -e "Vacuuming journal logs older than 3 days...\n"
    journalctl --vacuum-time=3d || true
    echo

    # Thumbnail cache
    echo -e "\033[1;36m── Thumbnail Cache ──\033[0m"
    local thumb_dir
    if [[ -n "$SUDO_USER" ]]; then
        thumb_dir="/home/$SUDO_USER/.cache/thumbnails"
    elif [[ -n "$SUDO_UID" ]]; then
        thumb_dir="$(getent passwd "$SUDO_UID" | cut -d: -f6)/.cache/thumbnails"
    fi

    if [[ -n "$thumb_dir" ]] && [[ -d "$thumb_dir" ]]; then
        local thumb_size
        thumb_size="$(du -sh "$thumb_dir" 2>/dev/null | cut -f1)"
        echo -e "Clearing thumbnail cache ($thumb_size)..."
        rm -rf "$thumb_dir"
        echo -e "\033[1;32mDone.\033[0m"
    else
        echo -e "No thumbnail cache found."
    fi
    echo

    # Font cache rebuild
    echo -e "\033[1;36m── Font Cache ──\033[0m"
    echo -e "Rebuilding font cache..."
    fc-cache -f 2>/dev/null && echo -e "\033[1;32mDone.\033[0m" || echo -e "\033[1;33mfc-cache not available.\033[0m"
    echo

    # Browser cache (opt-in)
    echo -e "\033[1;36m── Browser Cache ──\033[0m"
    echo -ne "\033[1;32mClear browser caches? (Firefox, Chromium, Chrome) [y/N] \033[0m"
    read -r response
    if [[ "$response" =~ ^[Yy]$ ]]; then
        local user_home
        if [[ -n "$SUDO_USER" ]]; then
            user_home="/home/$SUDO_USER"
        elif [[ -n "$SUDO_UID" ]]; then
            user_home="$(getent passwd "$SUDO_UID" | cut -d: -f6)"
        fi

        if [[ -n "$user_home" ]]; then
            local cleared=false

            # Firefox
            local firefox_cache="$user_home/.cache/mozilla/firefox"
            if [[ -d "$firefox_cache" ]]; then
                local size
                size="$(du -sh "$firefox_cache" 2>/dev/null | cut -f1)"
                rm -rf "$firefox_cache"
                echo -e "  \033[2m•\033[0m Firefox cache cleared ($size)"
                cleared=true
            fi

            # Chromium
            local chromium_cache="$user_home/.cache/chromium"
            if [[ -d "$chromium_cache" ]]; then
                local size
                size="$(du -sh "$chromium_cache" 2>/dev/null | cut -f1)"
                rm -rf "$chromium_cache"
                echo -e "  \033[2m•\033[0m Chromium cache cleared ($size)"
                cleared=true
            fi

            # Chrome
            local chrome_cache="$user_home/.cache/google-chrome"
            if [[ -d "$chrome_cache" ]]; then
                local size
                size="$(du -sh "$chrome_cache" 2>/dev/null | cut -f1)"
                rm -rf "$chrome_cache"
                echo -e "  \033[2m•\033[0m Chrome cache cleared ($size)"
                cleared=true
            fi

            if [[ "$cleared" == false ]]; then
                echo -e "  No browser caches found."
            fi
        fi
    else
        echo -e "\033[2mSkipped.\033[0m"
    fi
}

# ─── Pacnew file handling ────────────────────────────────────────────
do_pacnew() {
    echo -e "\n\033[1;33m-->\033[1;34m Pacnew File Management\033[0m\n"

    # Auto-remove mirrorlist pacnew files (cachy-update manages mirrors)
    local mirror_pacnews
    mirror_pacnews="$(find /etc/pacman.d -name 'mirrorlist*.pacnew' -o -name '*-mirrorlist.pacnew' 2>/dev/null)" || true

    if [[ -n "$mirror_pacnews" ]]; then
        echo -e "\033[1;36m── Auto-removing mirrorlist .pacnew files ──\033[0m"
        echo -e "\033[2m(cachy-update manages mirror lists, these are always stale)\033[0m\n"
        echo "$mirror_pacnews" | while IFS= read -r f; do
            rm -f "$f"
            echo -e "  \033[2m•\033[0m Removed: $f"
        done
        echo
    fi

    # Find remaining pacnew/pacsave files
    local pacfiles
    pacfiles="$(find /etc -name '*.pacnew' -o -name '*.pacsave' 2>/dev/null)" || true

    if [[ -z "$pacfiles" ]]; then
        echo -e "\033[1;32mNo .pacnew or .pacsave files found. System is clean.\033[0m"
        return 0
    fi

    echo -e "The following configuration files need attention:\n"
    echo "$pacfiles" | while IFS= read -r f; do
        echo -e "  \033[2m•\033[0m $f"
    done
    echo

    if command -v pacdiff >/dev/null; then
        echo -ne "\033[1;32mLaunch pacdiff to review these files? [y/N] \033[0m"
        read -r response
        if [[ "$response" =~ ^[Yy]$ ]]; then
            echo
            pacdiff
        else
            echo -e "\033[2mSkipped. Run 'sudo pacdiff' later to review.\033[0m"
        fi
    else
        echo -e "\033[2mInstall pacman-contrib for pacdiff: sudo pacman -S pacman-contrib\033[0m"
    fi
}
